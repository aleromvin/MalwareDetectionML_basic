# Several plots
# Alexander Romero Vinogradov, <aleromvin@gmail.com>

library(tidyverse)
library(tidymodels)
library(corrplot)
library(rpart.plot)
library(NeuralNetTools)
library(ggplot2)

load("./modelos/models1.RData")

# Corrplots:

# First we look for correlated numerical variables

malware_training %>%
  select_if(is.numeric) %>%
  cor() -> matcor

png(filename = "corrplot1.png", width = 1000, height = 1000)
matcor %>% corrplot()
dev.off()

# Mostly not too high correlation between variables
# However we do see some exceptions

# Before removing variables with high correlation, though, we will apply transformations for lowering the skewness of a subset of the numeric variables. For visualization purposes, let's apply this transformation to the data directly:

malware_training %>%
  mutate(
    across(
      tidyselect::starts_with("e_") | c(SizeOfCode, SizeOfInitializedData,
                                        SizeOfUninitializedData, AddressOfEntryPoint, BaseOfCode,
                                        BaseOfData, CheckSum, SizeOfStackReserve, SizeOfStackCommit,
                                        SizeOfHeapReserve, SizeOfHeapCommit, sus_sections, filesize), asinh)
  ) %>%
  select_if(is.numeric) %>%
  cor() -> matcor2

png(filename = "corrplot2.png", width = 1000, height = 1000)
matcor2 %>% corrplot()
dev.off()


# Plotting the models:

malware_final_dt_fit %>%
  extract_fit_engine() -> modeloArbol

png(filename = "visualizeDT.png", width = 1000, height = 600)
rpart.plot(modeloArbol, fallen.leaves = F, roundint = F, type = 5, box.palette = c("lightgreen","salmon"))
dev.off()

#################

malware_final_rf_fit %>% 
  extract_fit_engine() -> modeloRF

png(filename = "visualizeRF.png", width = 1000, height = 1000)
modeloRF$variable.importance %>%
  enframe(name = "Variable", value = "Importance") %>% 
  ggplot(aes(
    x    = reorder(Variable, Importance),
    y    = Importance,
    fill = Importance)
  ) +
  labs(x = "Variable", title = "Variable importance (impurity)") +
  geom_col() +
  scale_fill_viridis_c() +
  coord_flip() +
  theme_bw() +
  theme(legend.position = "none")
dev.off()

#################

malware_final_mlp_fit %>%
  extract_fit_engine() -> modeloMLP

png(filename = "visualizeMLP.png", width = 2000, height = 2000)
plotnet(modeloMLP)
dev.off()